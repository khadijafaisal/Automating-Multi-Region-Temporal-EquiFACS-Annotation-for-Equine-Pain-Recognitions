!pip install ultralytics

# COPY TO YOLO DIRECTORY STRUCTURE
print("\nORGANIZING DATASET FOR YOLO TRAINING")

yolo_root = os.path.join(config.OUTPUT_ROOT, "yolo_dataset")
for split in ['train', 'val']:
    os.makedirs(os.path.join(yolo_root, 'images', split), exist_ok=True)
    os.makedirs(os.path.join(yolo_root, 'labels', split), exist_ok=True)

def copy_data(data_list, split):
    counter = 0
    for item in tqdm(data_list, desc=f"Copying {split}"):
        # Copy image
        img_dst = os.path.join(yolo_root, 'images', split, f"{split}_{counter:06d}.jpg")
        shutil.copy(item['frame_path'], img_dst)
        
        # Copy/create label
        lbl_dst = os.path.join(yolo_root, 'labels', split, f"{split}_{counter:06d}.txt")
        
        if item['num_nostrils'] > 0:
            # Copy existing valid label
            with open(lbl_dst, 'w') as f:
                for bbox in item['valid_boxes']:
                    cls, x, y, w, h = bbox
                    f.write(f"{cls} {x:.6f} {y:.6f} {w:.6f} {h:.6f}\n")
        else:
            # Create empty label file for background
            open(lbl_dst, 'w').close()
        
        counter += 1

copy_data(train_data, 'train')
copy_data(val_data, 'val')

# CREATE DATA.YAML
yaml_content = f"""
# Nostril Detection Dataset (Balanced)
path: {yolo_root}
train: images/train
val: images/val

nc: 1
names: ['nostril']

# Training optimizations for low precision issue
augment: True
mixup: 0.1
copy_paste: 0.1
"""

with open(os.path.join(yolo_root, 'data.yaml'), 'w') as f:
    f.write(yaml_content)

print(f"\n data.yaml created at {os.path.join(yolo_root, 'data.yaml')}")

# VISUALIZING SAMPLES (QUALITY CHECK)
if config.VISUALIZE_SAMPLES:
    print("\nVISUALIZING SAMPLE ANNOTATIONS")
    
    fig, axes = plt.subplots(2, 5, figsize=(20, 8))
    axes = axes.flatten()
    
    samples = random.sample(train_data[:100], min(config.NUM_VIS_SAMPLES, len(train_data)))
    
    for idx, item in enumerate(samples):
        img = cv2.imread(item['frame_path'])
        img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        h, w = img.shape[:2]
        
        # Draw bounding boxes
        for bbox in item['valid_boxes']:
            cls, x_c, y_c, bw, bh = bbox
            x1 = int((x_c - bw/2) * w)
            y1 = int((y_c - bh/2) * h)
            x2 = int((x_c + bw/2) * w)
            y2 = int((y_c + bh/2) * h)
            
            cv2.rectangle(img, (x1, y1), (x2, y2), (0, 255, 0), 2)
        
        axes[idx].imshow(img)
        axes[idx].set_title(f"{item['video']}\n{item['num_nostrils']} nostrils")
        axes[idx].axis('off')
    
    plt.tight_layout()
    plt.savefig(os.path.join(config.OUTPUT_ROOT, 'sample_annotations.png'), dpi=150)
    print(f" Visualization saved to {config.OUTPUT_ROOT}/sample_annotations.png")

# TRAIN YOLO WITH OPTIMIZED HYPERPARAMETERS
print("\n STARTING YOLO TRAINING (OPTIMIZED FOR PRECISION)")

from ultralytics import YOLO

# Loading pretrained model
model = YOLO('yolov8n.pt')

# Train with precision-focused hyperparameters
results = model.train(
    data=os.path.join(yolo_root, 'data.yaml'),
    epochs=100,
    imgsz=640,
    batch=16,
    patience=20,
    
    # CRITICAL CHANGES FOR PRECISION IMPROVEMENT
    cls=1.0,        # Increase classification loss weight (was 0.5)
    box=7.5,        # Keep box loss
    conf=0.001,     # Lower confidence threshold to catch more during training
    iou=0.5,        # Stricter IoU for NMS
    
    # Advanced augmentation
    augment=True,
    mixup=0.15,         # Mix images to improve generalization
    copy_paste=0.1,     # Copy-paste nostrils
    mosaic=1.0,
    degrees=10,         # Slight rotation
    translate=0.1,
    scale=0.3,
    flipud=0.5,         # Vertical flip (nostrils can be upside down)
    
    # Optimizer
    optimizer='AdamW',
    lr0=0.001,
    momentum=0.937,
    weight_decay=0.0005,
    
    # Output
    project=os.path.join(config.OUTPUT_ROOT, 'runs'),
    name='nostril_balanced_v1',
    exist_ok=True,
    pretrained=True,
    verbose=True
)

print("TRAINING COMPLETED")
print(f"Results saved to: {config.OUTPUT_ROOT}/runs/nostril_balanced_v1")

from ultralytics import YOLO
from pathlib import Path
import cv2
import numpy as np
from tqdm import tqdm
import json
import torch

BEST_PT = Path("/kaggle/working/nostril_balanced/runs/nostril_balanced_v1/weights/best.pt")
yolo = YOLO(str(BEST_PT))

print("Loaded nostril YOLO model:", BEST_PT)

import os, json

DATASET_IMG = Path("/kaggle/working/nostril_balanced/yolo_dataset/images")
OUTPUT_PRED = Path("/kaggle/working/nostril_balanced/yolo_predictions.json")

pred_dict = {}

for split in ["train", "val"]:
    img_dir = DATASET_IMG / split
    imgs = sorted(img_dir.glob("*.jpg"))

    for img in tqdm(imgs, desc=f"Infer {split}"):
        res = yolo(img)[0]

        if not hasattr(res, "boxes") or len(res.boxes) == 0:
            continue

        xyxy = res.boxes.xyxy.cpu().numpy()
        conf = res.boxes.conf.cpu().numpy()
        cls = res.boxes.cls.cpu().numpy().astype(int)

        best = -1
        best_box = None

        for i,c in enumerate(cls):
            if c != 0:  
                continue
            if conf[i] > best:
                best = conf[i]
                best_box = xyxy[i].tolist()

        if best_box is not None:
            pred_dict[img.name] = {
                "bbox": best_box,
                "conf": float(best),
                "split": split
            }

json.dump(pred_dict, open(OUTPUT_PRED, "w"), indent=2)
print("Saved predictions -> ", OUTPUT_PRED)
print("Total detections:", len(pred_dict))
